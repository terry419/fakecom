**3D 모듈형 엣지 조립 및 적층 시스템 (Revised: 2025-12-22)**

본 설계서는 GDD의 철학을 나무 단위의 코드로 변환하기 위한 최종 명세입니다.

#### **Phase 1: 기초 데이터 및 엣지 물리 엔진 (정밀 보정)**

| 순번 | 단계 | 대상 스크립트 | 주요 수정/생성 내용 및 메서드 로직 |
| :---- | :---- | :---- | :---- |
| **1.1** | 엣지 데이터 정의 | EdgeInfo.cs | • **내용:** EdgeType, CoverType 정의.  |
| **1.2** | 타일 구조 개편 | Tile.cs | • **구조:** 기존 Dictionary를 폐기하고 **EdgeInfo\[4\] 고정 배열** 사용. (0:N, 1:E, 2:S, 3:W) 2222  • **점유:** **ITileOccupant 인터페이스**로 점유 시스템 통일. (유닛, 오브젝트 구분 시 interface 타입 캐스팅 활용) 33 |
| **1.3** | **공간 정보 유틸리티** | **GridUtils.cs** | • **상수:** **LEVEL\_HEIGHT \= 2.5f** 정의. 4444  • **Snap:** SnapCoordinate 시 Y축은 2.5f 단위를 기준으로 올림/내림 처리하여 유닛 잠김 현상 방지. 5 |
| **1.4** | O(1) 조회 시스템 | MapManager.cs | • **내용:** Dictionary 기반 조회 시스템 유지. IsInitialized 플래그로 유닛 배치 시점 보장. 6666 |
| **1.5** | **양방향 엣지 판정** | **MapManager.cs** | • **메서드:** IsEdgePassable(from, to). • **로직:** 배열 인덱스를 통해 내 타일의 나가는 벽과 앞 타일의 들어오는 벽을 동시 검증. 7 |
| **1.6** | **경로 데이터 구조** | **PathResult.cs** | • **내용:** List\<Vector3\> path, totalCost, cumulativeCosts를 포함. (이동 비용 11.2항 반영) 8 |

#### **Phase 2: 자동화 도구 및 실시간 동기화 (고도화)**

| 순번 | 단계 | 대상 스크립트 | 주요 수정/생성 내용 및 메서드 로직 |
| :---- | :---- | :---- | :---- |
| **2.1** | 건설 도구 아키텍처 | MapEditorTool.cs | • **내용:** BuildingGeneratorTool과 연동하여 씬 내 엣지 프리팹 즉시 배치. 9999 |
| **2.2** | 실시간 데이터 동기화 | BuildingGeneratorTool.cs | • **Undo:** Undo.RegisterCreatedObjectUndo를 통해 맵 생성 작업의 취소/복구 보장. 10101010 |
| **2.3** | **강제 미러링 정책** | **MapEditorTool.cs** | **양방향 실시간 검증(Cross-Check Interface):** 데이터를 물리적으로 양쪽에 주입하는 대신, `MapManager.IsEdgePassable(from, to)` 메서드에서 \*\*현재 타일의 '나가는 벽'과 대상 타일의 '들어오는 벽' 데이터를 실시간으로 대조(AND 연산)\*\*하여 통과 여부를 판정함. 이를 통해 한쪽 데이터만 파괴되어도 버그 없이 통로가 개방되도록 함.11 |
| **2.4** | 맵 유효성 검증 | MapEditorTool.cs | • **메서드:** ValidateMapSupport() 추가. 공중에 뜬 타일이나 엣지 배열이 비어있는 타일 리포팅. |
| **2.5** | 창문 및 특수 벽체 | BuildingGeneratorTool.cs | • **규격:** EdgeType.Window 배치 시 시야는 절반 통과, 이동은 차단하는 데이터 주입. 12121212 |
| **2.6** | 에디터 편의 기능 | MapEditorTool.cs | • **지우개:** Shift+클릭 시 해당 좌표의 Tile 및 EdgeInfo 배열 초기화 및 오브젝트 파괴. 13 |

#### **Phase 3: 적층, 기둥 및 구조 지지 판정**

| 순번 | 단계 | 대상 스크립트 | 주요 수정/생성 내용 및 메서드 로직 |
| :---- | :---- | :---- | :---- |
| **3.1** | 기둥 계층화 | Pillar.cs | • **내용:** 기둥 파괴 시 OnPillarCollapsed 이벤트 발생. 14141414 |
| **3.2** | **지지력 전파 엔진** | **MapManager.cs** | • **알고리즘:** \*\*BFS(상하좌우 4방향)\*\*를 통해 기둥/지면으로부터 지지력($S$) 전파. 15  • **공식:** $S\_{tile} \= \\max(S\_{neighbors}) \- 1$. |
| **3.3** | 실시간 붕괴 처리 | Tile.cs | • **로직:** 지지력 0 도달 시 타일 파괴. 위에 있는 유닛에게 \*\*\-(층수 \* 10\)\*\*의 낙하 데미지 적용. 16 |
| **3.4** | **Y축 연동** | **GridUtils.cs** | • **로직:** 모든 월드 좌표 연산 시 Coordinate.y \* 2.5f를 적용하여 층간 시각적 간격 확보. 17171717 |
| **3.5** | 건물 자동 생성기 | BuildingGeneratorTool.cs | • **메서드:** BuildRoom 호출 시 4면 엣지 배열에 EdgeType.Wall 일괄 자동 주입. 18181818 |

#### **Phase 4: 3D 시야 및 전투 엔진**

| 순번 | 단계 | 대상 스크립트 | 주요 수정/생성 내용 및 메서드 로직 |
| :---- | :---- | :---- | :---- |
| **4.1** | 3D 브레제남 시야 | MapManager.cs | • **보정:** 시야 레이캐스트 시작점을 유닛 발밑이 아닌 '머리 높이'로 상향 조정. 19 |
| **4.2** | **3D 전투 및 QTE** | **CombatCalculator.cs** | • **각도:** 내적 기반 AngleFactor 적용. 20 특수: \*\*뉴럴 싱크(NS) 기반 생존 확률 공식($P\_{Final}$)\*\*을 적용함. 싱크 5 미만 시 생존 확률은 0%이며, 그 외에는 유닛 상태와 디버프가 합산된 가변 확률에 따라 사망 위기 시 HP 1로 생존함.  |
| **4.3** | **방어 QTE 관리** | **CombatManager.cs** | • **순서:** 다수 타격 시 **무작위 대상 선정** 후 한 명씩 **순차적으로 QTE 패널 호출**. 22 |

